title: 【Rails】使用 Capistrano3 + Unicorn + Nginx 部署服务器
date: 2016-04-19 18:13:35
tags: ["Ruby", "Rails"]
categories: ["程序开发"]
---
### 背景
本文简单叙述了 Unicorn + Nginx 部署 Rails 项目的设定。
相较于传统的 Apache + Passenger，Unicorn + Nginx 的组合以其高效率而获得越来越多人的青睐。

<!-- more -->

### 导入 Unicorn
#### 安装
Gemfile:
```
gem 'unicorn'
```

```
$ bundle install
```

#### 设定

添加 config/unicorn.rb

```
config/unicorn.rb
# -*- coding: utf-8 -*-
worker_processes Integer(ENV["WEB_CONCURRENCY"] || 3)
timeout 15
preload_app true  # 更新時ダウンタイム無し

listen "/tmp/unicorn.sock"
pid "/tmp/unicorn.pid"

before_fork do |server, worker|
  Signal.trap 'TERM' do
    puts 'Unicorn master intercepting TERM and sending myself QUIT instead'
    Process.kill 'QUIT', Process.pid
  end

  defined?(ActiveRecord::Base) and
    ActiveRecord::Base.connection.disconnect!
end

after_fork do |server, worker|
  Signal.trap 'TERM' do
    puts 'Unicorn worker intercepting TERM and doing nothing. Wait for master to send QUIT'
  end

  defined?(ActiveRecord::Base) and
    ActiveRecord::Base.establish_connection
end

# ログの出力
stderr_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])
stdout_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])
```

### 导入 Capistrano3
#### 安装
Gemfile:

```
group :deployment do
  gem 'capistrano'
  gem 'capistrano_colors'
  gem 'capistrano-ext'
  gem 'capistrano_rsync_with_remote_cache'
end
```

```
$ bundle install
$ bundle exec cap install
```
#### 部署的设定
由上述命令生成 /Capfile 文件

```
require 'capistrano/setup'
require 'capistrano/deploy'

# rbenvを使用している場合
require 'capistrano/rbenv'

# デプロイ先のサーバで、ユーザディレクトリでrbenvをインストールしている場合
set :rbenv_type, :user
set :rbenv_ruby, '2.1.2'

require 'capistrano/bundler'
require 'capistrano/rails/assets'
require 'capistrano/rails/migrations'

require 'capistrano3/unicorn'

# Rails4から分離したsecrets.ymlの環境変数を .envファイルで管理する
set :linked_files, %w{config/secrets.yml .env}

# タスクを読み込むけど、今回は特に使わない
Dir.glob('lib/capistrano/tasks/*.rake').each { |r| import r }
```

config/deploy.rb
```
```
